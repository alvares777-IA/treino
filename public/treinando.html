<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <link rel="icon" type="image/png" href="/favicon.png?v=2">
    <title>Treinando</title>
    <link href="/lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/lib/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand">Exercicios do Treino</span>
            <a id="linkVoltar" href="/treinos.html" class="btn btn-outline-light btn-sm">Voltar</a>
        </div>
    </nav>

    <div class="container-fluid">
        <div id="alertTreino" class="alert d-none"></div>

        <div id="tabelaContainer" class="d-none">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Exercicio</th>
                            <th>Series</th>
                            <th>Reps</th>
                            <th>Peso</th>
                            <th>Calorias</th>
                            <th>Musculo</th>
                            <th>Descanso</th>
                            <th>Link</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaExercicios">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="/lib/jquery/jquery-3.6.0.min.js"></script>
    <script>
        var ajaxAtivo = 0;
        $.ajaxSetup({
            beforeSend: function() {
                ajaxAtivo++;
                $('button, .btn').prop('disabled', true);
            },
            complete: function() {
                ajaxAtivo--;
                if (ajaxAtivo <= 0) {
                    ajaxAtivo = 0;
                    $('button, .btn').prop('disabled', false);
                }
            }
        });


        function iniciarCronometro(botao) {
                var $btn = $(botao);
                
                // Evita múltiplos cliques se já estiver rodando
                if ($btn.hasClass('running')) return;
                
                $btn.addClass('running btn-warning text-dark').removeClass('btn-outline-warning');
                
                var tempo = 60; // 1 minuto
                
                var intervalo = setInterval(function() {
                    tempo--;
                    
                    var minutos = Math.floor(tempo / 60);
                    var segundos = tempo % 60;
                    
                    // Formata para 0:00
                    $btn.html('<i class="bi bi-clock-history"></i> ' + minutos + ':' + (segundos < 10 ? '0' : '') + segundos);
                    
                    if (tempo <= 0) {
                        clearInterval(intervalo);
                        $btn.removeClass('running btn-warning text-dark').addClass('btn-success text-white');
                        $btn.html('<i class="bi bi-check-lg"></i> Pronto!');
                        
                        // Opcional: Tocar um bip sonoro aqui
                        var beep = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
                        beep.play();

                        // Volta ao estado original após 3 segundos
                        setTimeout(function() {
                            $btn.removeClass('btn-success text-white').addClass('btn-outline-warning');
                            $btn.html('<i class="bi bi-stopwatch"></i> 1:00');
                            $btn.removeClass('running');
                        }, 3000);
                    }
                }, 1000);
        } 

        $(document).ready(function() {
            var params = new URLSearchParams(window.location.search);
            var idTreino = params.get('id_treino');
            var idUsuario = params.get('id_usuario');

            // Ajustar link voltar com parametros
            if (idUsuario) {
                var nome = params.get('nome') || '';
                $('#linkVoltar').attr('href', '/treinos.html?id_usuario=' + idUsuario + (nome ? '&nome=' + encodeURIComponent(nome) : ''));
            }

            if (!idTreino) {
                $('#alertTreino').removeClass('d-none').addClass('alert-danger').text('Treino nao informado.');
                return;
            }

            function formatUrl(url) {
                if (!url) return '';
                url = url.trim();
                if (url && !/^https?:\/\//i.test(url)) url = 'https://' + url;
                return url;
            }

            $.ajax({
                url: '/treinando/' + idTreino,
                type: 'GET',
                success: function(response) {
                    var tbody = $('#tabelaExercicios');
                    tbody.empty();
                    if (response.exercicios.length === 0) {
                        $('#alertTreino').removeClass('d-none alert-danger').addClass('alert-info').text('Nenhum exercicio encontrado para este treino.');
                        return;
                    }
                    /*response.exercicios.forEach(function(ex) {
                        var urlFormatada = formatUrl(ex.tx_url);
                        var linkCell = urlFormatada
                            ? '<a href="' + urlFormatada + '" target="_blank" class="btn btn-sm btn-outline-info"><i class="bi bi-play-circle"></i> Ver</a>'
                            : '';
                        tbody.append(
                            '<tr>' +
                            '<td>' + ex.no_exercicio + '</td>' +
                            '<td>' + (ex.qt_series || '-') + '</td>' +
                            '<td>' + (ex.qt_repeticao || '-') + '</td>' +
                            '<td>' + (ex.nr_peso ? ex.nr_peso + ' kg' : '-') + '</td>' +
                            '<td>' + linkCell + '</td>' +
                            '</tr>'
                        );
                    });*/
                    
                    response.exercicios.forEach(function(ex) {
                        var urlFormatada = formatUrl(ex.tx_url);
                        var linkCell = urlFormatada
                            ? '<a href="' + urlFormatada + '" target="_blank" class="btn btn-sm btn-outline-info"><i class="bi bi-play-circle"></i> Ver</a>'
                            : '';

                        // HTML do botão de cronômetro
                        var cronometroCell = '<td>' +
                            '<button class="btn btn-sm btn-outline-warning btn-timer" onclick="iniciarCronometro(this)">' +
                            '<i class="bi bi-stopwatch"></i> 1:00</button>' +
                            '</td>';

                        tbody.append(
                            '<tr>' +
                            '<td>' + ex.no_exercicio + '</td>' +
                            '<td>' + (ex.qt_series || '-') + '</td>' +
                            '<td>' + (ex.qt_repeticao || '-') + '</td>' +
                            '<td>' + (ex.nr_peso ? ex.nr_peso + ' kg' : '-') + '</td>' +
                            '<td>' + (ex.qt_calorias || '-') + '</td>' +
                            '<td>' + (ex.no_musculo || '-') + '</td>' +
                            cronometroCell +
                            '<td>' + linkCell + '</td>' +
                            '</tr>'
                        );
                    });

                    $('#tabelaContainer').removeClass('d-none');
                },
                error: function(xhr) {
                    if (xhr.status === 401) {
                        window.location.href = '/index.html';
                        return;
                    }
                    var msg = xhr.responseJSON ? xhr.responseJSON.message : "Erro ao buscar exercicios";
                    $('#alertTreino').removeClass('d-none alert-info').addClass('alert-danger').text(msg);
                }
            });

        });
    </script>
</body>
</html>
