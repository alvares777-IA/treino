<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon.png?v=2">
    <title>Minha Conta</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="/lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/lib/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-modern sticky-top mb-4">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold text-primary" href="/treinos.html">
                <i class="bi bi-lightning-charge-fill me-2"></i>Sistema de Treinos
            </a>
            <div class="d-flex align-items-center">
                <a id="btnAlunos" href="/alunos.html" class="btn btn-modern btn-modern-outline btn-sm me-2 d-none"><i
                        class="bi bi-people"></i> Alunos</a>
                <a id="btnAgenda" href="/agenda.html"
                    class="btn btn-modern btn-modern-outline btn-sm me-2 text-nowrap"><i
                        class="bi bi-calendar-week"></i> Agenda</a>
                <a id="btnAdmin" href="/admin.html"
                    class="btn btn-modern btn-modern-outline btn-sm me-2 d-none text-warning" title="Admin"><i
                        class="bi bi-gear"></i></a>
                <a href="/conta.html" class="btn btn-modern btn-modern-primary btn-sm me-2 active"
                    title="Minha Conta"><i class="bi bi-person-circle"></i></a>
                <button id="btnSair" class="btn btn-modern btn-modern-primary btn-sm">Sair</button>
            </div>
        </div>
    </nav>

    <div class="container" style="max-width: 600px;">
        <h4 class="fw-bold mb-4"><i class="bi bi-person-circle text-primary me-2"></i>Minha Conta</h4>
        <div id="alertConta" class="alert d-none rounded-3"></div>

        <div class="card-modern p-4 mb-4">
            <h6 class="fw-bold mb-3 text-uppercase small text-muted">Informações Básicas</h6>
            <div class="mb-3">
                <label class="form-label small fw-medium">Login</label>
                <input type="text" id="contaLogin" class="form-control form-control-modern" disabled>
            </div>
            <div class="mb-3">
                <label class="form-label small fw-medium">E-mail</label>
                <input type="email" id="contaEmail" class="form-control form-control-modern"
                    placeholder="seu@email.com">
            </div>
            <div class="mb-3">
                <label class="form-label small fw-medium">Nome</label>
                <input type="text" id="contaNome" class="form-control form-control-modern" required>
            </div>
        </div>

        <div class="card-modern p-4 mb-4">
            <h6 class="fw-bold mb-3 text-uppercase small text-muted">Medidas e Metas</h6>
            <div class="row g-3 mb-4">
                <div class="col-4">
                    <label class="form-label small fw-medium text-nowrap">Peso (kg)</label>
                    <input type="number" id="contaPeso" class="form-control form-control-modern" step="0.1" min="0">
                </div>
                <div class="col-4">
                    <label class="form-label small fw-medium text-nowrap">Altura (cm)</label>
                    <input type="number" id="contaAltura" class="form-control form-control-modern" step="0.1" min="0">
                </div>
                <div class="col-4">
                    <label class="form-label small fw-medium text-nowrap">Meta (kg)</label>
                    <input type="number" id="contaPesoMeta" class="form-control form-control-modern" step="0.1" min="0">
                </div>
            </div>
            <button type="button" id="btnRegistrarMedidas" class="btn btn-modern btn-modern-outline w-100 py-3"><i
                    class="bi bi-clipboard-pulse"></i> Atualizar Medidas</button>
        </div>

        <div id="divHistoricoMedidas" class="card-modern p-4 mb-4 d-none">
            <h6 class="fw-bold mb-3 text-uppercase small text-muted">Histórico de Medidas</h6>
            <div class="table-responsive" style="max-height: 250px;">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="small fw-bold text-muted">Data</th>
                            <th class="small fw-bold text-muted">Peso</th>
                            <th class="small fw-bold text-muted text-nowrap">Alt</th>
                            <th class="small fw-bold text-muted text-nowrap">Meta</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaMedidas" class="small"></tbody>
                </table>
            </div>
        </div>

        <div class="card-modern p-4 mb-4">
            <h6 class="fw-bold mb-3 text-uppercase small text-muted">Segurança</h6>
            <div id="avisoSenhaTemp"
                class="alert bg-warning-subtle text-warning-emphasis border-0 mb-4 rounded-3 small">
                <i class="bi bi-exclamation-triangle me-2"></i>Senha temporária detectada. Por favor, defina uma nova
                senha.
            </div>
            <p id="dicaSenha" class="text-muted small mb-3">Preencha apenas se desejar alterar sua senha atual.</p>
            <div class="mb-3" id="divSenhaAtual">
                <label class="form-label small fw-medium">Senha Atual</label>
                <input type="password" id="contaSenhaAtual" class="form-control form-control-modern">
            </div>
            <div class="mb-0">
                <label class="form-label small fw-medium">Nova Senha</label>
                <input type="password" id="contaSenhaNova" class="form-control form-control-modern">
            </div>
        </div>

        <!-- Seção Meu Treinador -->
        <div id="secaoMeuTreinador" class="card-modern p-4 mb-4 d-none">
            <h6 class="fw-bold mb-3 text-uppercase small text-muted">Vínculos</h6>
            <div id="treinadorAtual" class="d-none bg-primary-subtle border-0 rounded-4 p-4 text-center">
                <i class="bi bi-person-workspace fs-1 d-block mb-2 text-primary"></i>
                <div class="fw-bold text-primary mb-1" id="nomeTreinadorAtual"></div>
                <div class="text-primary small mb-4 opacity-75" id="emailTreinadorAtual"></div>
                <button id="btnAbandonarTreinador"
                    class="btn btn-modern btn-modern-outline text-danger border-danger-subtle bg-white w-100"><i
                        class="bi bi-person-x"></i> Desvincular Treinador</button>
            </div>
            <div id="semTreinador" class="d-none">
                <p class="text-muted small mb-3">Você não possui um treinador vinculado.</p>
                <div class="input-group gap-2">
                    <input type="email" id="emailSolicitarTreinador" class="form-control form-control-modern"
                        placeholder="E-mail do treinador">
                    <button id="btnSolicitarTreinador"
                        class="btn btn-modern btn-modern-primary px-4 shadow-sm">Solicitar</button>
                </div>
                <div id="alertSolicitacao" class="alert d-none mt-3 rounded-3"></div>
            </div>
        </div>
        <!-- Info para TRE -->
        <div id="secaoInfoTreinador" class="card-modern p-4 mb-4 d-none bg-primary-subtle border-0 text-center">
            <i class="bi bi-mortarboard fs-1 d-block mb-2 text-primary"></i>
            <p class="text-primary fw-bold mb-0">Você é um treinador certificado.</p>
        </div>

        <div class="d-flex gap-3 mt-4 mb-5">
            <a href="#" id="btnVoltar" class="btn btn-modern btn-modern-outline w-100 py-3 text-muted">Voltar</a>
            <button type="button" id="btnSalvarConta"
                class="btn btn-modern btn-modern-primary w-100 py-3 shadow-sm">Salvar Alterações</button>
        </div>
    </div>

    <script src="/lib/jquery/jquery-3.6.0.min.js"></script>
    <script src="/lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/js/common.js"></script>
    <script>
        var trocarSenhaObrigatorio = new URLSearchParams(window.location.search).get('trocar_senha') === '1';

        function carregarDadosConta() {
            if (trocarSenhaObrigatorio) {
                $('#divSenhaAtual').addClass('d-none');
                $('#dicaSenha').addClass('d-none');
                $('#avisoSenhaTemp').removeClass('d-none');
            }
            $.ajax({
                url: '/usuario',
                type: 'GET',
                success: function (response) {
                    $('#contaLogin').val(response.no_login);
                    $('#contaEmail').val(response.tx_email || '');
                    $('#contaNome').val(response.no_usuario);
                    $('#contaPeso').val(response.nr_peso || '');
                    $('#contaAltura').val(response.nr_altura || '');
                    $('#contaPesoMeta').val(response.nr_pesometa || '');
                    carregarHistoricoMedidas();

                    var tipo = response.ao_tipo || 'USU';
                    if (tipo === 'ADM') {
                        $('#secaoMeuTreinador').addClass('d-none');
                        $('#secaoInfoTreinador').removeClass('d-none');
                    } else {
                        if (tipo === 'TRE') {
                            $('#secaoInfoTreinador').removeClass('d-none');
                        } else {
                            $('#secaoInfoTreinador').addClass('d-none');
                        }
                        $('#secaoMeuTreinador').removeClass('d-none');
                        carregarMeuTreinador();
                    }

                    if (trocarSenhaObrigatorio) {
                        $('#contaSenhaNova').focus();
                    }
                },
                error: function (xhr) {
                    if (xhr.status === 401) { window.location.href = '/index.html'; return; }
                    $('#alertConta').removeClass('d-none alert-success').addClass('alert-danger').text('Erro ao carregar dados da conta.');
                }
            });
        }

        function carregarMeuTreinador() {
            $.ajax({
                url: '/meu-treinador',
                type: 'GET',
                success: function (response) {
                    if (response.treinador) {
                        $('#treinadorAtual').removeClass('d-none');
                        $('#semTreinador').addClass('d-none');
                        $('#nomeTreinadorAtual').text(response.treinador.no_usuario);
                        $('#emailTreinadorAtual').text(response.treinador.tx_email || '');
                    } else {
                        $('#treinadorAtual').addClass('d-none');
                        $('#semTreinador').removeClass('d-none');
                    }
                }
            });
        }

        function carregarHistoricoMedidas() {
            $.ajax({
                url: '/usuario/medidas',
                type: 'GET',
                success: function (response) {
                    var tbody = $('#tabelaMedidas');
                    tbody.empty();
                    if (response.medidas.length === 0) {
                        $('#divHistoricoMedidas').addClass('d-none');
                        return;
                    }
                    $('#divHistoricoMedidas').removeClass('d-none');
                    response.medidas.forEach(function (m) {
                        tbody.append(
                            '<tr>' +
                            '<td>' + m.dt_medida + '</td>' +
                            '<td>' + (m.nr_peso || '-') + '</td>' +
                            '<td>' + (m.nr_altura || '-') + '</td>' +
                            '<td>' + (m.nr_pesometa || '-') + '</td>' +
                            '</tr>'
                        );
                    });
                }
            });
        }

        // Registrar medidas
        $('#btnRegistrarMedidas').on('click', function () {
            var dados = {
                nr_peso: $('#contaPeso').val() || null,
                nr_altura: $('#contaAltura').val() || null,
                nr_pesometa: $('#contaPesoMeta').val() || null
            };
            $.ajax({
                url: '/usuario/medidas',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(dados),
                success: function (response) {
                    $('#alertConta').removeClass('d-none alert-danger').addClass('alert-success').text(response.message);
                    setTimeout(function () { $('#alertConta').addClass('d-none'); }, 2000);
                    carregarHistoricoMedidas();
                },
                error: function (xhr) {
                    var msg = xhr.responseJSON ? xhr.responseJSON.message : "Erro ao registrar medida";
                    $('#alertConta').removeClass('d-none alert-success').addClass('alert-danger').text(msg);
                }
            });
        });

        // Salvar conta
        $('#btnSalvarConta').on('click', function () {
            var nome = $('#contaNome').val().trim();
            if (!nome) {
                $('#alertConta').removeClass('d-none alert-success').addClass('alert-danger').text('Informe o nome.');
                return;
            }
            if (trocarSenhaObrigatorio && !$('#contaSenhaNova').val().trim()) {
                $('#alertConta').removeClass('d-none alert-success').addClass('alert-danger').text('Informe a nova senha.');
                return;
            }
            var dados = {
                no_usuario: nome,
                tx_email: $('#contaEmail').val().trim(),
                no_senha_atual: $('#contaSenhaAtual').val(),
                no_senha_nova: $('#contaSenhaNova').val(),
                nr_peso: $('#contaPeso').val() || null,
                nr_altura: $('#contaAltura').val() || null,
                nr_pesometa: $('#contaPesoMeta').val() || null
            };
            $.ajax({
                url: '/usuario',
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(dados),
                success: function (response) {
                    $('#alertConta').removeClass('d-none alert-danger').addClass('alert-success').text(response.message);
                    $('#contaSenhaAtual').val('');
                    $('#contaSenhaNova').val('');
                    if (trocarSenhaObrigatorio) {
                        trocarSenhaObrigatorio = false;
                        window.history.replaceState({}, '', '/conta.html');
                        $('#divSenhaAtual').removeClass('d-none');
                        $('#dicaSenha').removeClass('d-none');
                        $('#avisoSenhaTemp').addClass('d-none');
                    }
                },
                error: function (xhr) {
                    if (xhr.status === 401) { window.location.href = '/index.html'; return; }
                    var msg = xhr.responseJSON ? xhr.responseJSON.message : "Erro ao atualizar conta";
                    $('#alertConta').removeClass('d-none alert-success').addClass('alert-danger').text(msg);
                }
            });
        });

        // Abandonar treinador
        $('#btnAbandonarTreinador').on('click', function () {
            var nome = $('#nomeTreinadorAtual').text();
            if (!confirm('Abandonar treinador "' + nome + '"?')) return;
            $.ajax({
                url: '/meu-treinador',
                type: 'DELETE',
                success: function () {
                    carregarMeuTreinador();
                },
                error: function (xhr) {
                    if (xhr.status === 401) { window.location.href = '/index.html'; return; }
                    var msg = xhr.responseJSON ? xhr.responseJSON.message : "Erro ao abandonar treinador";
                    alert(msg);
                }
            });
        });

        // Solicitar treinador
        $('#btnSolicitarTreinador').on('click', function () {
            var email = $('#emailSolicitarTreinador').val().trim();
            if (!email) {
                $('#alertSolicitacao').removeClass('d-none alert-success').addClass('alert-danger').text('Informe o e-mail do treinador.');
                return;
            }
            $.ajax({
                url: '/solicitacao-treinador',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ tx_email_treinador: email }),
                success: function (response) {
                    $('#alertSolicitacao').removeClass('d-none alert-danger').addClass('alert-success').text(response.message);
                    $('#emailSolicitarTreinador').val('');
                },
                error: function (xhr) {
                    var msg = xhr.responseJSON ? xhr.responseJSON.message : "Erro ao enviar solicitacao";
                    $('#alertSolicitacao').removeClass('d-none alert-success').addClass('alert-danger').text(msg);
                }
            });
        });

        // Botao voltar - volta para treinos ou alunos conforme tipo
        $('#btnVoltar').on('click', function (e) {
            e.preventDefault();
            if (tipoUsuario === 'TRE' || tipoUsuario === 'ADM') {
                window.location.href = '/alunos.html';
            } else {
                window.location.href = '/treinos.html';
            }
        });

        // Inicializar
        $(document).ready(function () {
            inicializar(function () {
                carregarDadosConta();
            });
        });
    </script>
</body>

</html>