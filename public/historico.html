<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon.png?v=2">
    <title>Histórico de Treinos</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="/lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/lib/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-modern sticky-top mb-4">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold text-primary" href="/treinos.html">
                <i class="bi bi-clock-history me-2"></i>Histórico de Treinos
            </a>
            <a href="/treinos.html" class="btn btn-modern btn-modern-outline btn-sm">Voltar</a>
        </div>
    </nav>

    <div class="container">
        <div id="alertHistorico" class="alert d-none rounded-3"></div>

        <div class="card-modern p-4 mb-4">
            <h6 class="fw-bold mb-3 text-uppercase small text-muted">Filtrar por Período</h6>
            <div class="row g-3 align-items-end">
                <div class="col-12 col-md-4">
                    <label class="form-label small fw-medium">De</label>
                    <input type="date" id="filtroInicio" class="form-control form-control-modern">
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label small fw-medium">Até</label>
                    <input type="date" id="filtroFim" class="form-control form-control-modern">
                </div>
                <div class="col-12 col-md-4">
                    <button id="btnConsultar" class="btn btn-modern btn-modern-primary w-100 py-2 shadow-sm"><i
                            class="bi bi-search"></i> Consultar</button>
                </div>
            </div>
        </div>

        <div id="tabelaContainer" class="d-none">
            <div class="card-modern">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4 text-uppercase small fw-bold text-muted">Data / Hora</th>
                                <th class="text-uppercase small fw-bold text-muted">Treino</th>
                                <th class="text-uppercase small fw-bold text-muted">Exercício</th>
                                <th class="text-uppercase small fw-bold text-muted">Séries</th>
                                <th class="text-uppercase small fw-bold text-muted">Reps</th>
                                <th class="text-uppercase small fw-bold text-muted">Peso</th>
                                <th class="text-uppercase small fw-bold text-muted">Calorias</th>
                                <th class="pe-4 text-center text-uppercase small fw-bold text-muted"
                                    style="width:120px;">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaHistorico">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Registro -->
    <div class="modal fade" id="modalEditarRegistro" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Editar Registro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div id="alertEditarRegistro" class="alert d-none rounded-3"></div>
                    <input type="hidden" id="editRegistroId">
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">Séries</label>
                        <input type="number" id="editRegistroSeries" class="form-control form-control-modern" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">Repetições</label>
                        <input type="number" id="editRegistroReps" class="form-control form-control-modern" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">Peso (kg)</label>
                        <input type="number" id="editRegistroPeso" class="form-control form-control-modern" min="0"
                            step="0.5">
                    </div>
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-muted">Calorias</label>
                        <input type="number" id="editRegistroCalorias" class="form-control form-control-modern" min="0">
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-modern btn-modern-outline w-100"
                            data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" id="btnSalvarRegistro"
                            class="btn btn-modern btn-modern-primary w-100">Salvar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/lib/jquery/jquery-3.6.0.min.js"></script>
    <script src="/lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script>
        var params = new URLSearchParams(window.location.search);
        var idUsuario = params.get('id_usuario');
        var queryParam = idUsuario ? '?id_usuario=' + idUsuario : '';
        var isProprioUsuario = !idUsuario;

        // Ajustar link voltar com parametros
        if (idUsuario) {
            var nome = params.get('nome') || '';
            $('a[href="/treinos.html"]').attr('href', '/treinos.html?id_usuario=' + idUsuario + (nome ? '&nome=' + encodeURIComponent(nome) : ''));
        }

        function formatDate(d) {
            return d.toISOString().substring(0, 10);
        }

        function carregarHistorico() {
            var dtInicio = $('#filtroInicio').val();
            var dtFim = $('#filtroFim').val();

            // Construir URL de forma robusta
            var url = '/treino-dia';
            var params = [];
            if (idUsuario) params.push('id_usuario=' + idUsuario);
            if (dtInicio) params.push('dt_inicio=' + dtInicio);
            if (dtFim) params.push('dt_fim=' + dtFim);

            if (params.length > 0) {
                url += '?' + params.join('&');
            }

            $.ajax({
                url: url,
                type: 'GET',
                success: function (response) {
                    var tbody = $('#tabelaHistorico');
                    tbody.empty();
                    $('#alertHistorico').addClass('d-none');

                    if (!response.historico || response.historico.length === 0) {
                        $('#alertHistorico').removeClass('d-none alert-danger').addClass('alert-info').text('Nenhum registro encontrado no período.');
                        $('#tabelaContainer').addClass('d-none');
                        return;
                    }

                    $('#tabelaContainer').removeClass('d-none');
                    var totalGeral = 0;
                    var subtotalSessao = 0;
                    var sessaoAtual = null;

                    response.historico.forEach(function (item) {
                        // Agrupar por data e treino (Sessão)
                        // item.dt_treino vem formatado do banco: 'DD/MM/YYYY HH24:MI'
                        var dataSessao = item.dt_treino ? item.dt_treino.substring(0, 10) : '';
                        var chaveSessao = dataSessao + '|' + item.id_treino;

                        if (sessaoAtual !== null && sessaoAtual !== chaveSessao) {
                            renderSubtotal(tbody, subtotalSessao);
                            subtotalSessao = 0;
                        }

                        sessaoAtual = chaveSessao;
                        var calEx = item.qt_calorias || 0;
                        subtotalSessao += calEx;
                        totalGeral += calEx;

                        var acoes = '';
                        if (isProprioUsuario && item.id_treino_dia) {
                            acoes =
                                '<button class="btn btn-sm btn-modern btn-modern-outline py-1 px-2 btn-editar-reg me-1" data-id="' + item.id_treino_dia + '" data-series="' + (item.qt_series || '') + '" data-reps="' + (item.qt_repeticao || '') + '" data-peso="' + (item.nr_peso || '') + '" data-calorias="' + (item.qt_calorias || '') + '"><i class="bi bi-pencil"></i></button>' +
                                '<button class="btn btn-sm btn-modern btn-modern-outline py-1 px-2 text-danger btn-excluir-reg" data-id="' + item.id_treino_dia + '"><i class="bi bi-trash"></i></button>';
                        }

                        tbody.append(
                            '<tr data-id="' + item.id_treino_dia + '">' +
                            '<td class="ps-4 small text-muted">' + (item.dt_treino || '-') + '</td>' +
                            '<td class="fw-medium">' + item.no_treino + '</td>' +
                            '<td>' + (item.no_exercicio || '-') + '</td>' +
                            '<td class="text-center">' + (item.qt_series || '-') + '</td>' +
                            '<td class="text-center">' + (item.qt_repeticao || '-') + '</td>' +
                            '<td class="text-center fw-bold text-primary">' + (item.nr_peso ? item.nr_peso + 'kg' : '-') + '</td>' +
                            '<td class="text-center"><span class="badge rounded-pill bg-light text-dark border fw-normal">' + (item.qt_calorias || 0) + ' kcal</span></td>' +
                            '<td class="text-center text-nowrap pe-4">' + acoes + '</td>' +
                            '</tr>'
                        );
                    });

                    // Ultimo subtotal
                    if (sessaoAtual !== null) {
                        renderSubtotal(tbody, subtotalSessao);
                    }

                    // Total Geral
                    tbody.append(
                        '<tr class="bg-primary-subtle fw-bold">' +
                        '<td colspan="6" class="ps-4 text-primary">TOTAL ACUMULADO NO PERÍODO</td>' +
                        '<td class="text-center text-primary">' + totalGeral + ' kcal</td>' +
                        '<td class="pe-4"></td>' +
                        '</tr>'
                    );
                },
                error: function (xhr) {
                    if (xhr.status === 401) {
                        window.location.href = '/index.html';
                        return;
                    }
                    var msg = xhr.responseJSON ? xhr.responseJSON.message : "Erro ao buscar histórico";
                    $('#alertHistorico').removeClass('d-none alert-info').addClass('alert-danger').text(msg);
                }
            });
        }

        function renderSubtotal(tbody, cal) {
            tbody.append(
                '<tr class="bg-light bg-opacity-50 small fw-bold">' +
                '<td colspan="6" class="ps-4 text-muted">Subtotal da sessão</td>' +
                '<td class="text-center text-dark">' + cal + ' kcal</td>' +
                '<td class="pe-4"></td>' +
                '</tr>'
            );
        }

        // Event Listeners
        $(document).ready(function () {
            // Default: ultimos 7 dias
            var hoje = new Date();
            var seteDiasAtras = new Date();
            seteDiasAtras.setDate(hoje.getDate() - 7);

            $('#filtroInicio').val(formatDate(seteDiasAtras));
            $('#filtroFim').val(formatDate(hoje));

            carregarHistorico();
        });

        $('#btnConsultar').on('click', function () {
            carregarHistorico();
        });

        $(document).on('click', '.btn-excluir-reg', function () {
            var id = $(this).data('id');
            if (!confirm('Excluir este registro?')) return;
            $.ajax({
                url: '/treino-dia/' + id,
                type: 'DELETE',
                success: carregarHistorico,
                error: function (xhr) {
                    alert(xhr.responseJSON ? xhr.responseJSON.message : "Erro ao excluir");
                }
            });
        });

        $(document).on('click', '.btn-editar-reg', function () {
            var btn = $(this);
            $('#editRegistroId').val(btn.data('id'));
            $('#editRegistroSeries').val(btn.data('series'));
            $('#editRegistroReps').val(btn.data('reps'));
            $('#editRegistroPeso').val(btn.data('peso'));
            $('#editRegistroCalorias').val(btn.data('calorias'));
            $('#alertEditarRegistro').addClass('d-none');
            new bootstrap.Modal(document.getElementById('modalEditarRegistro')).show();
        });

        $('#btnSalvarRegistro').on('click', function () {
            var id = $('#editRegistroId').val();
            var dados = {
                qt_series: $('#editRegistroSeries').val() || null,
                qt_repeticao: $('#editRegistroReps').val() || null,
                nr_peso: $('#editRegistroPeso').val() || null,
                qt_calorias: $('#editRegistroCalorias').val() || null
            };
            $.ajax({
                url: '/treino-dia/' + id,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(dados),
                success: function () {
                    bootstrap.Modal.getInstance(document.getElementById('modalEditarRegistro')).hide();
                    carregarHistorico();
                },
                error: function (xhr) {
                    var msg = xhr.responseJSON ? xhr.responseJSON.message : "Erro ao atualizar";
                    $('#alertEditarRegistro').removeClass('d-none alert-success').addClass('alert-danger').text(msg);
                }
            });
        });
    </script>
</body>

</html>