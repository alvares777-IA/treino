<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon.png?v=2">
    <title>Historico de Treinos</title>
    <link href="/lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/lib/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand"><i class="bi bi-clock-history"></i> Historico de Treinos</span>
            <a href="/treinos.html" class="btn btn-outline-light btn-sm">Voltar</a>
        </div>
    </nav>

    <div class="container-fluid">
        <div id="alertHistorico" class="alert d-none"></div>

        <div class="row g-2 align-items-end mb-3">
            <div class="col-auto">
                <label class="form-label small mb-1">De</label>
                <input type="date" id="filtroInicio" class="form-control form-control-sm">
            </div>
            <div class="col-auto">
                <label class="form-label small mb-1">At√©</label>
                <input type="date" id="filtroFim" class="form-control form-control-sm">
            </div>
            <div class="col-auto">
                <button id="btnConsultar" class="btn btn-primary btn-sm"><i class="bi bi-search"></i> Consultar</button>
            </div>
        </div>

        <div id="tabelaContainer" class="d-none">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Data / Hora</th>
                            <th>Treino</th>
                            <th>Exercicio</th>
                            <th>Series</th>
                            <th>Reps</th>
                            <th>Peso</th>
                            <th>Calorias</th>
                            <th style="width:100px;">Acoes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaHistorico">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Editar Registro -->
    <div class="modal fade" id="modalEditarRegistro" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Registro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="alertEditarRegistro" class="alert d-none"></div>
                    <input type="hidden" id="editRegistroId">
                    <div class="mb-3">
                        <label class="form-label">Series</label>
                        <input type="number" id="editRegistroSeries" class="form-control" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Repeticoes</label>
                        <input type="number" id="editRegistroReps" class="form-control" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Peso (kg)</label>
                        <input type="number" id="editRegistroPeso" class="form-control" min="0" step="0.5">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Calorias</label>
                        <input type="number" id="editRegistroCalorias" class="form-control" min="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" id="btnSalvarRegistro" class="btn btn-primary">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/lib/jquery/jquery-3.6.0.min.js"></script>
    <script src="/lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script>
        var ajaxAtivo = 0;
        $.ajaxSetup({
            beforeSend: function () {
                ajaxAtivo++;
                $('button, .btn').prop('disabled', true);
            },
            complete: function () {
                ajaxAtivo--;
                if (ajaxAtivo <= 0) {
                    ajaxAtivo = 0;
                    $('button, .btn').prop('disabled', false);
                }
            }
        });

        var params = new URLSearchParams(window.location.search);
        var idUsuario = params.get('id_usuario');
        var queryParam = idUsuario ? '?id_usuario=' + idUsuario : '';
        var isProprioUsuario = !idUsuario;

        // Ajustar link voltar com parametros
        if (idUsuario) {
            var nome = params.get('nome') || '';
            $('a[href="/treinos.html"]').attr('href', '/treinos.html?id_usuario=' + idUsuario + (nome ? '&nome=' + encodeURIComponent(nome) : ''));
        }

        // Default: ultimos 7 dias
        var hoje = new Date();
        var seteDiasAtras = new Date();
        seteDiasAtras.setDate(hoje.getDate() - 7);
        function formatDate(d) {
            return d.toISOString().substring(0, 10);
        }
        $('#filtroInicio').val(formatDate(seteDiasAtras));
        $('#filtroFim').val(formatDate(hoje));

        function carregarHistorico() {
            var dtInicio = $('#filtroInicio').val();
            var dtFim = $('#filtroFim').val();
            var sep = queryParam ? '&' : '?';
            var urlFiltro = '/treino-dia' + queryParam + (dtInicio ? sep + 'dt_inicio=' + dtInicio : '') + (dtFim ? (queryParam || dtInicio ? '&' : '?') + 'dt_fim=' + dtFim : '');
            $.ajax({
                url: urlFiltro,
                type: 'GET',
                success: function (response) {
                    var tbody = $('#tabelaHistorico');
                    tbody.empty();
                    if (response.historico.length === 0) {
                        $('#alertHistorico').removeClass('d-none alert-danger').addClass('alert-info').text('Nenhum treino registrado ainda.');
                        $('#tabelaContainer').addClass('d-none');
                        return;
                    }
                    var totalGeral = 0;
                    var totalDia = 0;
                    var totalTreino = 0;
                    var diaAtual = null;
                    var treinoAtual = null;
                    var nomeTreinoAtual = '';
                    var numCols = 8;

                    response.historico.forEach(function (item, idx) {
                        var dia = item.dt_treino ? item.dt_treino.substring(0, 10) : '';
                        var chaveTreino = dia + '|' + item.id_treino;
                        var calExercicio = item.qt_calorias || 0;

                        // Quebra de treino (mesmo dia, treino diferente) ou quebra de dia
                        if (treinoAtual !== null && treinoAtual !== chaveTreino) {
                            tbody.append(
                                '<tr class="table-info fw-bold"><td colspan="6" class="text-end">Subtotal ' + nomeTreinoAtual + ':</td><td class="text-center">' + totalTreino + '</td><td></td></tr>'
                            );
                            totalTreino = 0;
                        }

                        // Quebra de dia
                        if (diaAtual !== null && diaAtual !== dia) {
                            tbody.append(
                                '<tr class="table-warning fw-bold"><td colspan="6" class="text-end">Total do dia ' + diaAtual + ':</td><td class="text-center">' + totalDia + '</td><td></td></tr>'
                            );
                            totalDia = 0;
                        }

                        diaAtual = dia;
                        treinoAtual = chaveTreino;
                        nomeTreinoAtual = item.no_treino;

                        totalTreino += calExercicio;
                        totalDia += calExercicio;
                        totalGeral += calExercicio;

                        var acoes = '';
                        if (isProprioUsuario && item.id_treino_dia) {
                            acoes =
                                '<button class="btn btn-sm btn-outline-primary btn-editar-reg me-1" data-id="' + item.id_treino_dia + '" data-series="' + (item.qt_series || '') + '" data-reps="' + (item.qt_repeticao || '') + '" data-peso="' + (item.nr_peso || '') + '" data-calorias="' + (item.qt_calorias || '') + '"><i class="bi bi-pencil-square"></i></button>' +
                                '<button class="btn btn-sm btn-outline-danger btn-excluir-reg" data-id="' + item.id_treino_dia + '"><i class="bi bi-trash"></i></button>';
                        }
                        tbody.append(
                            '<tr data-id="' + (item.id_treino_dia || '') + '">' +
                            '<td>' + item.dt_treino + '</td>' +
                            '<td>' + item.no_treino + '</td>' +
                            '<td>' + (item.no_exercicio || '-') + '</td>' +
                            '<td>' + (item.qt_series || '-') + '</td>' +
                            '<td>' + (item.qt_repeticao || '-') + '</td>' +
                            '<td>' + (item.nr_peso ? item.nr_peso + ' kg' : '-') + '</td>' +
                            '<td class="text-center">' + (calExercicio || '-') + '</td>' +
                            '<td class="text-center">' + acoes + '</td>' +
                            '</tr>'
                        );
                    });

                    // Subtotal do ultimo treino
                    if (treinoAtual !== null) {
                        tbody.append(
                            '<tr class="table-info fw-bold"><td colspan="6" class="text-end">Subtotal ' + nomeTreinoAtual + ':</td><td class="text-center">' + totalTreino + '</td><td></td></tr>'
                        );
                    }
                    // Total do ultimo dia
                    if (diaAtual !== null) {
                        tbody.append(
                            '<tr class="table-warning fw-bold"><td colspan="6" class="text-end">Total do dia ' + diaAtual + ':</td><td class="text-center">' + totalDia + '</td><td></td></tr>'
                        );
                    }
                    // Total geral
                    tbody.append(
                        '<tr class="table-dark fw-bold"><td colspan="6" class="text-end">TOTAL GERAL:</td><td class="text-center">' + totalGeral + '</td><td></td></tr>'
                    );
                    $('#tabelaContainer').removeClass('d-none');
                },
                error: function (xhr) {
                    if (xhr.status === 401) {
                        window.location.href = '/index.html';
                        return;
                    }
                    var msg = xhr.responseJSON ? xhr.responseJSON.message : "Erro ao buscar historico";
                    $('#alertHistorico').removeClass('d-none alert-info').addClass('alert-danger').text(msg);
                }
            });
        }

        // Excluir registro
        $(document).on('click', '.btn-excluir-reg', function () {
            var id = $(this).data('id');
            if (!confirm('Excluir este registro?')) return;
            $.ajax({
                url: '/treino-dia/' + id,
                type: 'DELETE',
                success: function () {
                    carregarHistorico();
                },
                error: function (xhr) {
                    var msg = xhr.responseJSON ? xhr.responseJSON.message : "Erro ao excluir";
                    alert(msg);
                }
            });
        });

        // Editar registro - abrir modal
        $(document).on('click', '.btn-editar-reg', function () {
            var btn = $(this);
            $('#editRegistroId').val(btn.data('id'));
            $('#editRegistroSeries').val(btn.data('series'));
            $('#editRegistroReps').val(btn.data('reps'));
            $('#editRegistroPeso').val(btn.data('peso'));
            $('#editRegistroCalorias').val(btn.data('calorias'));
            $('#alertEditarRegistro').addClass('d-none');
            new bootstrap.Modal(document.getElementById('modalEditarRegistro')).show();
        });

        // Salvar edicao
        $('#btnSalvarRegistro').on('click', function () {
            var id = $('#editRegistroId').val();
            var dados = {
                qt_series: $('#editRegistroSeries').val() || null,
                qt_repeticao: $('#editRegistroReps').val() || null,
                nr_peso: $('#editRegistroPeso').val() || null,
                qt_calorias: $('#editRegistroCalorias').val() || null
            };
            $.ajax({
                url: '/treino-dia/' + id,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(dados),
                success: function () {
                    bootstrap.Modal.getInstance(document.getElementById('modalEditarRegistro')).hide();
                    carregarHistorico();
                },
                error: function (xhr) {
                    var msg = xhr.responseJSON ? xhr.responseJSON.message : "Erro ao atualizar";
                    $('#alertEditarRegistro').removeClass('d-none alert-success').addClass('alert-danger').text(msg);
                }
            });
        });

        $('#btnConsultar').on('click', function () {
            carregarHistorico();
        });

        $(document).ready(function () {
            carregarHistorico();
        });
    </script>
</body>

</html>