<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon.png?v=2">
    <title>Administração</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="/lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/lib/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-modern sticky-top mb-4">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold text-primary" href="/treinos.html">
                <i class="bi bi-shield-lock me-2"></i>Portal Administrativo
            </a>
            <div class="d-flex align-items-center">
                <a href="/treinos.html" class="btn btn-modern btn-modern-outline btn-sm me-2">Voltar</a>
                <button id="btnSair" class="btn btn-modern btn-modern-primary btn-sm">Sair</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <h4 class="fw-bold mb-4">Gerenciamento do Sistema</h4>
        <div id="alertAdmin" class="alert d-none rounded-3"></div>

        <ul class="nav nav-pills nav-fill mb-4 p-1 bg-light rounded-4 gap-1" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active rounded-4 fw-medium py-3" data-bs-toggle="tab"
                    data-bs-target="#tabExercicios" type="button" role="tab">
                    <i class="bi bi-database-add me-2"></i>Academia de Exercícios
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link rounded-4 fw-medium py-3" data-bs-toggle="tab" data-bs-target="#tabVinculos"
                    type="button" role="tab">
                    <i class="bi bi-people me-2"></i>Vínculos Aluno-Treinador
                </button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- ABA EXERCICIOS ACADEMIA -->
            <div class="tab-pane fade show active" id="tabExercicios">
                <div id="alertExercicios" class="alert d-none rounded-3"></div>

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-bold mb-0 text-muted text-uppercase small">Biblioteca de Exercícios</h6>
                    <button id="btnNovoExAcademia" class="btn btn-modern btn-modern-primary btn-sm px-4">
                        <i class="bi bi-plus-lg"></i> Novo Exercício
                    </button>
                </div>

                <!-- Form novo/editar exercicio -->
                <div id="formExAcademia" class="d-none card-modern p-4 mb-4 bg-light bg-opacity-50">
                    <h6 class="fw-bold mb-3">Detalhes do Exercício</h6>
                    <input type="hidden" id="exAcademiaId">
                    <div class="row g-3 mb-4">
                        <div class="col-12 col-md-6">
                            <label class="form-label small fw-medium">Nome</label>
                            <input type="text" id="exAcademiaNome" class="form-control form-control-modern"
                                placeholder="Ex: Supino Reto">
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label small fw-medium">URL de Referência</label>
                            <input type="url" id="exAcademiaUrl" class="form-control form-control-modern"
                                placeholder="https://...">
                        </div>
                        <div class="col-6 col-md-4">
                            <label class="form-label small fw-medium">Calorias Est.</label>
                            <input type="number" id="exAcademiaCalorias" class="form-control form-control-modern"
                                placeholder="0" min="0">
                        </div>
                        <div class="col-6 col-md-4">
                            <label class="form-label small fw-medium">Músculo Alvo</label>
                            <input type="text" id="exAcademiaMusculo" class="form-control form-control-modern"
                                placeholder="Ex: Peitoral">
                        </div>
                        <div class="col-12 col-md-4">
                            <label class="form-label small fw-medium">Tipo Sugerido</label>
                            <input type="text" id="exAcademiaTreino" class="form-control form-control-modern"
                                placeholder="Ex: A, B, C...">
                        </div>
                    </div>
                    <div class="d-flex gap-2 justify-content-end">
                        <button id="btnCancelarExAcademia"
                            class="btn btn-modern btn-modern-outline px-4">Cancelar</button>
                        <button id="btnSalvarExAcademia"
                            class="btn btn-modern btn-modern-primary px-5 shadow-sm">Salvar</button>
                    </div>
                </div>

                <div class="card-modern">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4 text-uppercase small fw-bold text-muted">Exercício</th>
                                    <th class="text-center text-uppercase small fw-bold text-muted">Ref.</th>
                                    <th class="text-center text-uppercase small fw-bold text-muted">Calorias</th>
                                    <th class="text-uppercase small fw-bold text-muted">Músculo</th>
                                    <th class="text-uppercase small fw-bold text-muted">Tipo</th>
                                    <th class="pe-4 text-center text-uppercase small fw-bold text-muted"
                                        style="width:120px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaExAcademia"></tbody>
                        </table>
                    </div>
                </div>
                <p id="semExAcademia" class="text-muted text-center d-none">Nenhum exercicio cadastrado.</p>
            </div>

            <!-- ABA VINCULOS -->
            <div class="tab-pane fade" id="tabVinculos">
                <div id="alertVinculos" class="alert d-none rounded-3"></div>

                <div class="card-modern p-4 mb-4">
                    <h6 class="fw-bold mb-3 text-uppercase small text-muted">Selecionar Treinador</h6>
                    <div class="row g-3">
                        <div class="col-12">
                            <select id="selectTreinador" class="form-select form-control-modern">
                                <option value="">-- Selecione para gerenciar alunos --</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Alunos do treinador selecionado -->
                <div id="divAlunosTreinador" class="d-none">
                    <div class="card-modern mb-4">
                        <div class="card-header bg-white border-bottom p-3">
                            <h6 class="fw-bold mb-0">Alunos Vinculados</h6>
                        </div>
                        <div id="listaAlunosTreinador" class="list-group list-group-flush"></div>
                        <p id="semAlunosTreinador" class="text-muted p-4 text-center d-none">Este treinador ainda não
                            possui alunos vinculados.</p>
                    </div>

                    <div class="card-modern p-4 bg-primary-subtle border-0">
                        <h6 class="fw-bold mb-3 text-primary">Vincular Novo Aluno</h6>
                        <div class="row g-3">
                            <div class="col-12 col-md-8">
                                <select id="selectAlunoSemTreinador" class="form-select form-control-modern">
                                    <option value="">-- Selecione um aluno disponível --</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-4">
                                <button id="btnVincularAluno"
                                    class="btn btn-modern btn-modern-primary w-100 shadow-sm">Vincular Agora</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/lib/jquery/jquery-3.6.0.min.js"></script>
    <script src="/lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script>
        var ajaxAtivo = 0;
        $.ajaxSetup({
            beforeSend: function () {
                ajaxAtivo++;
                $('button, .btn').prop('disabled', true);
            },
            complete: function () {
                ajaxAtivo--;
                if (ajaxAtivo <= 0) {
                    ajaxAtivo = 0;
                    $('button, .btn').prop('disabled', false);
                }
            }
        });

        // Verificar se e ADM
        $(document).ready(function () {
            $.ajax({
                url: '/usuario',
                type: 'GET',
                success: function (response) {
                    if (response.ao_tipo !== 'ADM') {
                        window.location.href = '/alunos.html';
                        return;
                    }
                    carregarExercicios();
                    carregarTreinadores();
                },
                error: function (xhr) {
                    if (xhr.status === 401) window.location.href = '/index.html';
                }
            });
        });

        // ==================== EXERCICIOS ACADEMIA ====================

        function carregarExercicios() {
            $.ajax({
                url: '/admin/exercicios-academia',
                type: 'GET',
                success: function (response) {
                    var tbody = $('#tabelaExAcademia');
                    tbody.empty();
                    if (response.exercicios.length === 0) {
                        $('#semExAcademia').removeClass('d-none');
                        return;
                    }
                    $('#semExAcademia').addClass('d-none');
                    response.exercicios.forEach(function (ex) {
                        var urlCell = ex.tx_url
                            ? '<a href="' + ex.tx_url + '" target="_blank" class="btn btn-sm btn-modern btn-modern-outline py-0 px-2" title="' + ex.tx_url + '"><i class="bi bi-play-circle"></i></a>'
                            : '-';
                        tbody.append(
                            '<tr data-id="' + ex.id_exercicio + '">' +
                            '<td class="ps-4 fw-medium text-dark">' + ex.no_exercicio + '</td>' +
                            '<td>' + (ex.no_musculo || '-') + '</td>' +
                            '<td class="text-center"><span class="badge rounded-pill bg-light text-dark border fw-normal">' + (ex.qt_calorias || 0) + ' kcal</span></td>' +
                            '<td class="text-center">' + urlCell + '</td>' +
                            '<td class="text-center text-nowrap pe-4">' +
                            '<button class="btn btn-sm btn-modern btn-modern-outline py-1 px-2 btn-editar-exa me-1" title="Editar"><i class="bi bi-pencil"></i></button>' +
                            '<button class="btn btn-sm btn-modern btn-modern-outline py-1 px-2 text-danger btn-excluir-exa" title="Excluir"><i class="bi bi-trash"></i></button>' +
                            '</td>' +
                            '</tr>'
                        );
                    });
                }
            });
        }

        var editandoExAcademia = false;

        $('#btnNovoExAcademia').on('click', function () {
            editandoExAcademia = false;
            $('#exAcademiaId').val('');
            $('#exAcademiaNome').val('');
            $('#exAcademiaUrl').val('');
            $('#exAcademiaCalorias').val('');
            $('#exAcademiaMusculo').val('');
            $('#exAcademiaTreino').val('');
            $('#formExAcademia').removeClass('d-none');
            $('#exAcademiaNome').focus();
        });

        $('#btnCancelarExAcademia').on('click', function () {
            $('#formExAcademia').addClass('d-none');
        });

        $(document).on('click', '.btn-editar-exa', function () {
            var row = $(this).closest('tr');
            editandoExAcademia = true;
            $('#exAcademiaId').val(row.data('id'));
            var cells = row.find('td');
            $('#exAcademiaNome').val(cells.eq(0).text());
            var link = cells.eq(1).find('a');
            $('#exAcademiaUrl').val(link.length ? link.attr('href') : '');
            var calorias = cells.eq(2).text().trim();
            $('#exAcademiaCalorias').val(calorias === '-' ? '' : calorias);
            var musculo = cells.eq(3).text().trim();
            $('#exAcademiaMusculo').val(musculo === '-' ? '' : musculo);
            var treino = cells.eq(4).text().trim();
            $('#exAcademiaTreino').val(treino === '-' ? '' : treino);
            $('#formExAcademia').removeClass('d-none');
            $('#exAcademiaNome').focus();
        });

        $(document).on('click', '.btn-excluir-exa', function () {
            var row = $(this).closest('tr');
            var id = row.data('id');
            var nome = row.find('td').eq(0).text();
            if (!confirm('Excluir exercicio "' + nome + '"?')) return;
            $.ajax({
                url: '/admin/exercicios-academia/' + id,
                type: 'DELETE',
                success: function () {
                    carregarExercicios();
                },
                error: function (xhr) {
                    var msg = xhr.responseJSON ? xhr.responseJSON.message : "Erro ao excluir";
                    alert(msg);
                }
            });
        });

        $('#btnSalvarExAcademia').on('click', function () {
            var nome = $('#exAcademiaNome').val().trim();
            if (!nome) {
                $('#alertExercicios').removeClass('d-none alert-success').addClass('alert-danger').text('Informe o nome do exercicio.');
                return;
            }
            var dados = {
                no_exercicio: nome,
                tx_url: $('#exAcademiaUrl').val().trim(),
                qt_calorias: $('#exAcademiaCalorias').val() || null,
                no_musculo: $('#exAcademiaMusculo').val().trim(),
                no_treino: $('#exAcademiaTreino').val().trim()
            };

            if (editandoExAcademia) {
                var id = $('#exAcademiaId').val();
                $.ajax({
                    url: '/admin/exercicios-academia/' + id,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(dados),
                    success: function () {
                        $('#formExAcademia').addClass('d-none');
                        $('#alertExercicios').removeClass('d-none alert-danger').addClass('alert-success').text('Exercicio atualizado!');
                        setTimeout(function () { $('#alertExercicios').addClass('d-none'); }, 2000);
                        carregarExercicios();
                    },
                    error: function (xhr) {
                        var msg = xhr.responseJSON ? xhr.responseJSON.message : "Erro ao atualizar";
                        $('#alertExercicios').removeClass('d-none alert-success').addClass('alert-danger').text(msg);
                    }
                });
            } else {
                $.ajax({
                    url: '/admin/exercicios-academia',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(dados),
                    success: function () {
                        $('#formExAcademia').addClass('d-none');
                        $('#alertExercicios').removeClass('d-none alert-danger').addClass('alert-success').text('Exercicio criado!');
                        setTimeout(function () { $('#alertExercicios').addClass('d-none'); }, 2000);
                        carregarExercicios();
                    },
                    error: function (xhr) {
                        var msg = xhr.responseJSON ? xhr.responseJSON.message : "Erro ao criar";
                        $('#alertExercicios').removeClass('d-none alert-success').addClass('alert-danger').text(msg);
                    }
                });
            }
        });

        // ==================== VINCULOS ====================

        function carregarTreinadores() {
            $.ajax({
                url: '/admin/treinadores',
                type: 'GET',
                success: function (response) {
                    var sel = $('#selectTreinador');
                    sel.html('<option value="">-- Selecione --</option>');
                    response.treinadores.forEach(function (t) {
                        sel.append('<option value="' + t.id_usuario + '">' + t.no_usuario + ' (' + (t.tx_email || '') + ')</option>');
                    });
                }
            });
        }

        $('#selectTreinador').on('change', function () {
            var id = $(this).val();
            if (!id) {
                $('#divAlunosTreinador').addClass('d-none');
                return;
            }
            $('#divAlunosTreinador').removeClass('d-none');
            carregarAlunosTreinador(id);
            carregarUsuariosSemTreinador();
        });

        function carregarAlunosTreinador(idTreinador) {
            $.ajax({
                url: '/admin/treinadores/' + idTreinador + '/alunos',
                type: 'GET',
                success: function (response) {
                    var lista = $('#listaAlunosTreinador');
                    lista.empty();
                    if (response.alunos.length === 0) {
                        $('#semAlunosTreinador').removeClass('d-none');
                        return;
                    }
                    $('#semAlunosTreinador').addClass('d-none');
                    response.alunos.forEach(function (a) {
                        lista.append(
                            '<div class="list-group-item d-flex justify-content-between align-items-center py-3 border-0 border-bottom px-4">' +
                            '<div><i class="bi bi-person text-primary me-3"></i> ' + a.no_usuario + ' <small class="text-muted ms-2">(' + (a.tx_email || '') + ')</small></div>' +
                            '<button class="btn btn-sm btn-modern btn-modern-outline text-danger btn-desvincular-admin" data-id-usuario="' + a.id_usuario + '"><i class="bi bi-person-x me-1"></i> Desvincular</button>' +
                            '</div>'
                        );
                    });
                }
            });
        }

        function carregarUsuariosSemTreinador() {
            $.ajax({
                url: '/admin/usuarios-sem-treinador',
                type: 'GET',
                success: function (response) {
                    var sel = $('#selectAlunoSemTreinador');
                    sel.html('<option value="">-- Selecione um aluno --</option>');
                    response.usuarios.forEach(function (u) {
                        sel.append('<option value="' + u.id_usuario + '">' + u.no_usuario + ' (' + (u.tx_email || '') + ')</option>');
                    });
                }
            });
        }

        $(document).on('click', '.btn-desvincular-admin', function () {
            var idUsuario = $(this).data('id-usuario');
            var idTreinador = $('#selectTreinador').val();
            if (!confirm('Desvincular este aluno do treinador?')) return;
            $.ajax({
                url: '/admin/vincular/' + idUsuario + '/' + idTreinador,
                type: 'DELETE',
                success: function () {
                    $('#alertVinculos').removeClass('d-none alert-danger').addClass('alert-success').text('Vinculo removido!');
                    setTimeout(function () { $('#alertVinculos').addClass('d-none'); }, 2000);
                    carregarAlunosTreinador(idTreinador);
                    carregarUsuariosSemTreinador();
                },
                error: function (xhr) {
                    var msg = xhr.responseJSON ? xhr.responseJSON.message : "Erro ao desvincular";
                    $('#alertVinculos').removeClass('d-none alert-success').addClass('alert-danger').text(msg);
                }
            });
        });

        $('#btnVincularAluno').on('click', function () {
            var idAluno = $('#selectAlunoSemTreinador').val();
            var idTreinador = $('#selectTreinador').val();
            if (!idAluno) {
                $('#alertVinculos').removeClass('d-none alert-success').addClass('alert-danger').text('Selecione um aluno.');
                return;
            }
            $.ajax({
                url: '/admin/vincular',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ id_usuario: Number(idAluno), id_treinador: Number(idTreinador) }),
                success: function () {
                    $('#alertVinculos').removeClass('d-none alert-danger').addClass('alert-success').text('Aluno vinculado com sucesso!');
                    setTimeout(function () { $('#alertVinculos').addClass('d-none'); }, 2000);
                    carregarAlunosTreinador(idTreinador);
                    carregarUsuariosSemTreinador();
                },
                error: function (xhr) {
                    var msg = xhr.responseJSON ? xhr.responseJSON.message : "Erro ao vincular";
                    $('#alertVinculos').removeClass('d-none alert-success').addClass('alert-danger').text(msg);
                }
            });
        });
    </script>
</body>

</html>